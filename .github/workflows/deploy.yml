name: Deploy to App Store

# This workflow builds and deploys the iOS app to the App Store.
# It is automatically triggered when a tag starting with 'v' is pushed (e.g., v1.0.0).
#
# Prerequisites:
# Before using this workflow, ensure you have configured the following repository secrets:
#   - MATCH_PASSWORD: Password for encrypting the certificates repository
#   - MATCH_GIT_URL: Git URL of the match certificates repository (e.g., git@github.com:user/certs.git)
#   - GIT_AUTHORIZATION: GitHub Personal Access Token with 'repo' scope for private repository access
#   - APPSTORE_ISSUER_ID: App Store Connect API Issuer ID (from App Store Connect)
#   - APPSTORE_KEY_ID: App Store Connect API Key ID (from App Store Connect)
#   - APPSTORE_P8: App Store Connect API .p8 key content (raw content, not base64-encoded)
#   - APPLE_TEAM_ID: Your Apple Developer Team ID (found in App Store Connect or Developer Portal)
#
# You must also run the "iOS One-Time Match Setup" workflow ONCE before using this deployment workflow.
#
# How to deploy:
#   1. Commit your changes and ensure your code is ready for release
#   2. Create and push a version tag: git tag v1.0.0 && git push origin v1.0.0
#   3. This workflow will automatically build and upload to App Store Connect

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: macos-latest
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        run: |
          # Check if all required secrets are configured
          missing_secrets=()
          
          if [ -z "${{ secrets.MATCH_PASSWORD }}" ]; then
            missing_secrets+=("MATCH_PASSWORD")
          fi
          
          if [ -z "${{ secrets.MATCH_GIT_URL }}" ]; then
            missing_secrets+=("MATCH_GIT_URL")
          fi
          
          if [ -z "${{ secrets.GIT_AUTHORIZATION }}" ]; then
            missing_secrets+=("GIT_AUTHORIZATION")
          fi
          
          if [ -z "${{ secrets.APPSTORE_ISSUER_ID }}" ]; then
            missing_secrets+=("APPSTORE_ISSUER_ID")
          fi
          
          if [ -z "${{ secrets.APPSTORE_KEY_ID }}" ]; then
            missing_secrets+=("APPSTORE_KEY_ID")
          fi
          
          if [ -z "${{ secrets.APPSTORE_P8 }}" ]; then
            missing_secrets+=("APPSTORE_P8")
          fi
          
          if [ -z "${{ secrets.APPLE_TEAM_ID }}" ]; then
            missing_secrets+=("APPLE_TEAM_ID")
          fi
          
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "‚ùå Error: The following required secrets are not configured:"
            for secret in "${missing_secrets[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "üìù Please configure these secrets in your repository settings:"
            echo "   Settings > Secrets and variables > Actions > Repository secrets"
            echo ""
            echo "Required secrets:"
            echo "  ‚Ä¢ MATCH_PASSWORD: Password for encrypting the certificates repository"
            echo "  ‚Ä¢ MATCH_GIT_URL: Git URL of the match certificates repository"
            echo "  ‚Ä¢ GIT_AUTHORIZATION: GitHub Personal Access Token with repo access"
            echo "  ‚Ä¢ APPSTORE_ISSUER_ID: App Store Connect API Issuer ID"
            echo "  ‚Ä¢ APPSTORE_KEY_ID: App Store Connect API Key ID"
            echo "  ‚Ä¢ APPSTORE_P8: App Store Connect API .p8 key content (raw, not base64)"
            echo "  ‚Ä¢ APPLE_TEAM_ID: Apple Developer Team ID"
            echo ""
            echo "For more information, see the README or workflow comments."
            exit 1
          fi
          
          echo "‚úÖ All required secrets are configured"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: npm ci

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Setup Xcode
        id: setup-xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios/App

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/App/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/App/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: cd ios/App && pod install

      - name: Cache Transporter CLI
        id: cache-transporter
        uses: actions/cache@v4
        with:
          path: /usr/local/itms
          key: ${{ runner.os }}-transporter-cli-v1

      - name: Install Transporter for App Store uploads
        if: steps.cache-transporter.outputs.cache-hit != 'true'
        run: |
          echo "üì¶ Installing Transporter for App Store uploads..."
          # Download and install Transporter from Apple
          # This is required for uploading builds to App Store Connect via Fastlane
          # The URL redirects to the actual package file
          # Note: Apple doesn't provide checksums for this download, but it's served over HTTPS
          curl -fsSL "https://itunesconnect.apple.com/WebObjects/iTunesConnect.woa/ra/resources/download/public/Transporter__OSX/bin/" -o "/tmp/itmstransporter.pkg"
          
          # Verify the download succeeded and file is not empty
          if [ ! -s "/tmp/itmstransporter.pkg" ]; then
            echo "‚ùå Failed to download Transporter package"
            exit 1
          fi
          
          echo "Installing Transporter package..."
          sudo installer -pkg "/tmp/itmstransporter.pkg" -target /
          
          # Verify installation by checking if the binary exists and is executable
          if [ -x "/usr/local/itms/bin/iTMSTransporter" ]; then
            echo "‚úÖ Transporter installed successfully at /usr/local/itms/bin/iTMSTransporter"
            ls -lh "/usr/local/itms/bin/iTMSTransporter"
          else
            echo "‚ùå Transporter installation failed - binary not found or not executable"
            exit 1
          fi

      - name: Verify copyright file
        uses: ./.github/actions/verify-copyright

      - name: Run Fastlane release
        env:
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_P8: ${{ secrets.APPSTORE_P8 }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GIT_AUTHORIZATION: ${{ secrets.GIT_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Increase timeout and retries for xcodebuild -showBuildSettings
          # to prevent hanging on slow CI environments (default: 3 seconds, 4 retries)
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 300
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 8
          # Configure App Store upload timeouts and optimizations
          FASTLANE_ITUNES_TRANSPORTER_TIMEOUT: 1800  # 30 minute timeout for uploads
          FASTLANE_ITUNES_TRANSPORTER_USE_SHELL_SCRIPT: 1  # Use shell script mode for better reliability
          FASTLANE_ITUNES_TRANSPORTER_PATH: /usr/local/itms  # Path to Transporter directory (not the binary itself)
          # Note: We use automatic transport discovery (no -t flag) per Apple's recommendation
          # See: https://help.apple.com/itc/transporteruserguide/#/apdATD1E1288-D1E1A1303-D1E1288A1126
        working-directory: ios/App
        run: bundle exec fastlane release

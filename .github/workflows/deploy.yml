name: Deploy to App Store

# This workflow builds and deploys the iOS app to the App Store.
# It is automatically triggered when a tag starting with 'v' is pushed (e.g., v1.0.0).
#
# Prerequisites:
# Before using this workflow, ensure you have configured the following repository secrets:
#   - MATCH_PASSWORD: Password for encrypting the certificates repository
#   - MATCH_GIT_URL: Git URL of the match certificates repository (e.g., git@github.com:user/certs.git)
#   - GIT_AUTHORIZATION: GitHub Personal Access Token with 'repo' scope for private repository access
#   - APPSTORE_ISSUER_ID: App Store Connect API Issuer ID (from App Store Connect)
#   - APPSTORE_KEY_ID: App Store Connect API Key ID (from App Store Connect)
#   - APPSTORE_P8: App Store Connect API .p8 key content (raw content, not base64-encoded)
#
# You must also run the "iOS One-Time Match Setup" workflow ONCE before using this deployment workflow.
#
# How to deploy:
#   1. Commit your changes and ensure your code is ready for release
#   2. Create and push a version tag: git tag v1.0.0 && git push origin v1.0.0
#   3. This workflow will automatically build and upload to App Store Connect

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: macos-latest
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          # Check if all required secrets are configured
          missing_secrets=()
          
          if [ -z "${{ secrets.MATCH_PASSWORD }}" ]; then
            missing_secrets+=("MATCH_PASSWORD")
          fi
          
          if [ -z "${{ secrets.MATCH_GIT_URL }}" ]; then
            missing_secrets+=("MATCH_GIT_URL")
          fi
          
          if [ -z "${{ secrets.GIT_AUTHORIZATION }}" ]; then
            missing_secrets+=("GIT_AUTHORIZATION")
          fi
          
          if [ -z "${{ secrets.APPSTORE_ISSUER_ID }}" ]; then
            missing_secrets+=("APPSTORE_ISSUER_ID")
          fi
          
          if [ -z "${{ secrets.APPSTORE_KEY_ID }}" ]; then
            missing_secrets+=("APPSTORE_KEY_ID")
          fi
          
          if [ -z "${{ secrets.APPSTORE_P8 }}" ]; then
            missing_secrets+=("APPSTORE_P8")
          fi
          
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "âŒ Error: The following required secrets are not configured:"
            for secret in "${missing_secrets[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "ðŸ“ Please configure these secrets in your repository settings:"
            echo "   Settings > Secrets and variables > Actions > Repository secrets"
            echo ""
            echo "Required secrets:"
            echo "  â€¢ MATCH_PASSWORD: Password for encrypting the certificates repository"
            echo "  â€¢ MATCH_GIT_URL: Git URL of the match certificates repository"
            echo "  â€¢ GIT_AUTHORIZATION: GitHub Personal Access Token with repo access"
            echo "  â€¢ APPSTORE_ISSUER_ID: App Store Connect API Issuer ID"
            echo "  â€¢ APPSTORE_KEY_ID: App Store Connect API Key ID"
            echo "  â€¢ APPSTORE_P8: App Store Connect API .p8 key content (raw, not base64)"
            echo ""
            echo "For more information, see the README or workflow comments."
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios/App

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/App/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/App/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies
        working-directory: ios/App
        run: pod install

      - name: Run Fastlane release
        env:
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_P8: ${{ secrets.APPSTORE_P8 }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          GIT_AUTHORIZATION: ${{ secrets.GIT_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          # Increase timeout and retries for xcodebuild -showBuildSettings
          # to prevent hanging on slow CI environments (default: 3 seconds, 4 retries)
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 300
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 8
        working-directory: ios/App
        run: bundle exec fastlane release
